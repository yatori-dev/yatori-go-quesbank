name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v0.0.2-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [üîß] ‰øÆÂ§çÈÉ®ÂàÜAIÂÆπÊòìÂá∫Áé∞ÁßòÈí•ËÆ§ËØÅÈîôËØØÈóÆÈ¢ò

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    env:
      GOTOOLCHAIN: local
      GOSUMDB: off
      GOPROXY: direct
      GONOSUMDB: "*"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get dependencies
        run: |
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy

      - name: Prepare Release Directory
        run: mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release

      - name: Build Linux AMD64
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release/${{ env.PROJECT_NAME }}

      - name: Create release tar
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release.tar.gz yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release
          rm -rf yatori-go-quesbank.${{env.VERSION}}-linux-amd64-release

      - name: Create GitHub Release with custom notes
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          draft: false
          prerelease: false
          tag_name: ${{ env.VERSION }}
          body: ${{env.RELEASE_NOTICES}}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: build-linux

    env:
      GOTOOLCHAIN: local
      GOSUMDB: off
      GOPROXY: direct
      GONOSUMDB: "*"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get dependencies
        run: |
          go clean -modcache
          del go.sum
          go mod tidy

      - name: Prepare Release Directory
        run: mkdir -p ${{ env.RELEASE_DIR }}\yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release

      - name: Build Windows AMD64
        run: |
          set CGO_ENABLED=0
          set GOOS=windows
          set GOARCH=amd64
          go build -o ${{ env.RELEASE_DIR }}\yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release\${{ env.PROJECT_NAME }}.exe

      - name: Create Release zip
        run: |
          copy command\config.yaml ${{ env.RELEASE_DIR }}\yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release
          copy command\start.bat ${{ env.RELEASE_DIR }}\yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release" -DestinationPath "yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release.zip"
          Remove-Item -Recurse -Force "yatori-go-quesbank.${{env.VERSION}}-windows-amd64-release"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          generate_release_notes: true
          draft: false
          prerelease: false
          tag_name: ${{ env.VERSION }}
